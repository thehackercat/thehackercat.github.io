<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        Twisted+gevent 异步+协程服务器开发 | LexusLee&#39;s Blog
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="LexusLee">
    <meta name="description" content="Be the change you want to see in the world.">
    <meta name="keywords" content="Lexus">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="LexusLee&#39;s Blog">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://lexuslee.me">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Twisted+gevent 异步+协程服务器开发 | LexusLee&#39;s Blog">
    <meta property="og:description" content="Be the change you want to see in the world.">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #00838F
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important
    }
    
	/* Sidebar User Drop Down Menu Text Color */
	#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #0097A7 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #0097A7 !important
    }
    
    .toTop{
        background: #757575 !important
    }
		
	.material-layout .material-post>.material-nav,
	.material-layout .material-index>.material-nav,
	.material-nav a{
		color: #757575;
	}
		
	#scheme-Paradox .MD-burger-layer {
		background-color: #757575;
	}

	#scheme-Paradox #post-toc-trigger-btn{
		color: #757575;
	}
	
	.post-toc a:hover{
		color: #00838F;
		text-decoration: underline;
	}
</style>


<!-- Theme Background Related-->

	<style>
		body{
            background-image: url(https://api.i-meto.com/bing?null);
        }
	</style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>

	<script src="/js/jquery.min.js"></script>
	
	<link rel="stylesheet" href="/css/highlight/solarized-white.css">
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                
	<!-- Back Button -->
<!--
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			
-->
	<!-- Left aligned menu below button -->
	<button id="post-toc-trigger-btn"
			class="mdl-button mdl-js-button mdl-button--icon">
	  <i class="material-icons">format_list_numbered</i>
	</button>

	<ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect"
		for="post-toc-trigger-btn">
			
			<ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#背景"><span class="post-toc-number">1.</span> <span class="post-toc-text">背景</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Twisted"><span class="post-toc-number">2.</span> <span class="post-toc-text">Twisted</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#gevent"><span class="post-toc-number">3.</span> <span class="post-toc-text">gevent</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-1-完成基础框架"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">Step 1 完成基础框架</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-2-完善基础框架"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">Step 2 完善基础框架</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-3-增加-rpc-实例"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">Step 3 增加 rpc 实例</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#欧勒！"><span class="post-toc-number">4.</span> <span class="post-toc-text">欧勒！</span></a></li></ol>
		
<!--			<li class="mdl-menu__item">Some Action</li>-->
	</ul>


<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
		
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		
			<!-- Random Thumbnail -->
			<div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
				<script>
    
    var randomNum;
    randomNum = Math.floor(Math.random() * 5 + 1);
    
    $(".post_thumbnail-random").css('background-image', 'url(' + '/img/random/' + randomNum + '.png' + ')');
    
</script>

		
	
        <p class="article-headline-p">
            Twisted+gevent 异步+协程服务器开发
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>LexusLee</strong>
        <span>Jul 04, 2016</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Twisted+gevent 异步+协程服务器开发&url=http://lexuslee.me//2016/07/04/2016-07-01-rpc-server/index.html&via=LexusLee" target="_blank">
        <li class="mdl-menu__item">
            Share to Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://lexuslee.me//2016/07/04/2016-07-01-rpc-server/index.html" target="_blank">
        <li class="mdl-menu__item">
            Share to Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Twisted+gevent 异步+协程服务器开发&url=http://lexuslee.me//2016/07/04/2016-07-01-rpc-server/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            Share to Weibo
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近接触到用 Twisted 来写个 RPC 服务器，对高并发、性能和大量长连接时的稳定性方面有要求，所以应该在 Twisted 的基础上再造些轮子，最后考虑用 Twisted + gevent 来实现 「异步+协程」的部分。</p>
<a id="more"></a>
<p>分别简要介绍下 Twisted 和 gevent。</p>
<h2 id="Twisted"><a href="#Twisted" class="headerlink" title="Twisted"></a>Twisted</h2><p>Twisted是用 Python 实现的基于事件驱动的异步的网络引擎框架。它封装了大部分主流的网络协议(传输层或应用层)，如 TCP、UDP、SSL/TLS、HTTP、IMAP、SSH、IRC以及FTP等，在这我主要会用到 TCP 协议。</p>
<p>使用 Twisted 的好处在于，它是以事件驱动编程实现的，所以提供了事件注册的回调函数的接口，每次接受到请求，获得了事件通知，就调用事件所注册的回调函数( Node.js 程序员可能比较熟悉)。这让我不必去操心服务器事件驱动的编写。</p>
<p>并且，在网络引擎方面，有心跳包和粘包的三方库，非常完善。</p>
<p>然而，Twisted 有一个缺陷，它的异步有点问题，单个连接建立后是一个进程，在进程里用多线程实现并发，但多个连接建立后仍然会出现同步阻塞的情况，所以这就要引入 gevent 来填充其性能上的缺陷。</p>
<h2 id="gevent"><a href="#gevent" class="headerlink" title="gevent"></a>gevent</h2><p>gevent 是一种基于协程的 Python 网络库，它用到 greenlet 提供的，封装了 libevent 事件循环的高层同步API。</p>
<p>如果你不知道什么是协程，那么可以简单这么理解：</p>
<p>协程就是由程序员自己编码实现调度的多线程。</p>
<p>而 gevent 对 greenlet 协程进行了封装，同时 gevent 提供了看上去非常像传统的基于线程模型编程的接口，但是在隐藏在下面做的是异步 I/O ，所以它以同步的编码实现了异步的功能。</p>
<p>##开搞</p>
<h3 id="Step-1-完成基础框架"><a href="#Step-1-完成基础框架" class="headerlink" title="Step 1 完成基础框架"></a>Step 1 完成基础框架</h3><p>首先由于我要编写一个 RPC 服务器(使用 TCP 协议)，所以需要先实现一个 TCP 服务器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">from</span> twisted.internet.protocol <span class="keyword">import</span> ServerFactory, ProcessProtocol</div><div class="line"><span class="keyword">from</span> twisted.protocols.basic <span class="keyword">import</span> LineReceiver</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</div><div class="line"></div><div class="line">PORT = <span class="number">5354</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CmdProtocol</span><span class="params">(LineReceiver)</span>:</span></div><div class="line">    client_ip = <span class="string">''</span></div><div class="line">    </div><div class="line">    <span class="comment"># 连接建立接口</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionMade</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 获得连接对端 ip</span></div><div class="line">        self.client_ip = self.transport.getPeer().host</div><div class="line">        print(<span class="string">"Client connection from %s"</span> % self.client_ip)</div><div class="line">  </div><div class="line">    <span class="comment"># 连接断开接口</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionLost</span><span class="params">(self, reason)</span>:</span></div><div class="line">        print(<span class="string">'Lost client connection. Reason: %s'</span> % reason)</div><div class="line"></div><div class="line">    <span class="comment"># 数据接收接口</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dataReceived</span><span class="params">(self, data)</span>:</span></div><div class="line">        print(<span class="string">'Cmd received from %s : %s'</span> % (self.client_ip, data))</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RPCFactory</span><span class="params">(ServerFactory)</span>:</span></div><div class="line">    <span class="comment"># 使用 CmdProtocol 与客户端通信</span></div><div class="line">    protocol = CmdProtocol</div><div class="line"></div><div class="line"><span class="comment"># 启动服务器</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    reactor.listenTCP(PORT, RPCFactory())</div><div class="line">    reactor.run()</div></pre></td></tr></table></figure>
<p>Twisted 提供3个非常基础的接口使程序员进行重写:</p>
<ul>
<li>connectionMade() 连接建立后执行操作 </li>
<li>connectionLost() 连接断开后执行操作</li>
<li>dataReceived() 接收到数据后触发操作</li>
</ul>
<p>这3个接口通常来说是必须的，以此基础上进行完善，可以看到我只是先输出了友好信息。</p>
<p>这样简单完成了一个 TCP 服务器，可以看出 Twisted 网络引擎的架构如下：</p>
<ol>
<li>先由程序员来制定一个或多个协议(该协议可以继承各种底层网络协议)。</li>
<li>接着指定唯一一个工厂，这个工厂必须声明使用的协议对象。</li>
<li>使用 reactor 选择监听模式、监听工厂和端口，开启服务器。</li>
</ol>
<h3 id="Step-2-完善基础框架"><a href="#Step-2-完善基础框架" class="headerlink" title="Step 2 完善基础框架"></a>Step 2 完善基础框架</h3><p>显然，这个 TCP 服务器基础框架显得有些单薄，我首先想到的是需要进行多客户端的控制及 ip 记录，故应有个队列来实时更新连接入服务器的 ip。</p>
<p>并且，最近有好几部电影在豆瓣我标记了，我想和高圆圆一起去看，所以不能一直盯着屏幕来观察反馈，所以需要一个日志系统来记录反馈信息。</p>
<p>故增加一个 log.py 日志系统文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># log.py</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> logging.handlers</div><div class="line"><span class="keyword">from</span> twisted.python <span class="keyword">import</span> log</div><div class="line"></div><div class="line"><span class="comment">#当前执行文件所在地址</span></div><div class="line">CURRENT_PATH = os.getcwd()</div><div class="line"><span class="comment">#日志文件路径</span></div><div class="line">LOG_FILE = CURRENT_PATH + <span class="string">'/rpcserver.log'</span></div><div class="line"><span class="comment"># 全局日志模块</span></div><div class="line">gl_logger = <span class="keyword">None</span> </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">log</span><span class="params">(Protocol)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_log</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> gl_logger</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        os.makedirs(os.path.dirname(LOG_FILE))</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="comment"># 实例化handler </span></div><div class="line">    handler = logging.handlers.RotatingFileHandler(LOG_FILE, maxBytes=<span class="number">1024</span> * <span class="number">1024</span>, backupCount=<span class="number">1</span>)   </div><div class="line">    fmt = <span class="string">'[%(asctime)s][%(levelname)s][%(filename)s:%(lineno)d:%(funcName)s] - %(message)s'</span>    </div><div class="line">     <span class="comment"># 实例化formatter</span></div><div class="line">    formatter = logging.Formatter(fmt)</div><div class="line">    <span class="comment"># 为handler添加formatter</span></div><div class="line">    handler.setFormatter(formatter)</div><div class="line">    <span class="comment"># 获取名为rpcserver的logger</span></div><div class="line">    gl_logger = logging.getLogger(<span class="string">'rpcserver'</span>)</div><div class="line">    <span class="comment"># 为logger添加handler    </span></div><div class="line">    loggergl_logger.addHandler(handler)</div><div class="line">    handlergl_logger.setLevel(logging.DEBUG)</div><div class="line"></div><div class="line">    gl_logger.info(<span class="string">"----------------------------------"</span>)</div></pre></td></tr></table></figure>
<p>并在 server.py 中添加如下代码：<br>(添加多连接控制，把 print 替换为 log.msg 来打印日志)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">from</span> twisted.internet.protocol <span class="keyword">import</span> ServerFactory, ProcessProtocol</div><div class="line"><span class="keyword">from</span> twisted.protocols.basic <span class="keyword">import</span> LineReceiver</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</div><div class="line"><span class="keyword">from</span> twisted.python <span class="keyword">import</span> log</div><div class="line"></div><div class="line">PORT = <span class="number">5354</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CmdProtocol</span><span class="params">(LineReceiver)</span>:</span></div><div class="line">    client_ip = <span class="string">''</span></div><div class="line">    </div><div class="line">    <span class="comment"># 连接建立接口</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionMade</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 获得连接对端 ip</span></div><div class="line">        self.client_ip = self.transport.getPeer().host</div><div class="line">        log.msg(<span class="string">"Client connection from %s"</span> % self.client_ip)</div><div class="line">        </div><div class="line">        <span class="comment"># 进行多连接控制</span></div><div class="line">        <span class="keyword">if</span> len(self.factory.clients) &gt;= self.factory.clients_max:</div><div class="line">            log.msg(<span class="string">"Too many connections. Disconnect!"</span>)</div><div class="line">            self.client_ip = <span class="keyword">None</span></div><div class="line">            self.transport.loseConnection()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.factory.clients.append(self.client_ip)</div><div class="line">  </div><div class="line">    <span class="comment"># 连接断开接口</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionLost</span><span class="params">(self, reason)</span>:</span></div><div class="line">        log.msg(<span class="string">'Lost client connection. Reason: %s'</span> % reason)</div><div class="line">        <span class="keyword">if</span> self.client_ip:</div><div class="line">            self.factory.clients.remove(self.client_ip)</div><div class="line"></div><div class="line">    <span class="comment"># 数据接收接口</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dataReceived</span><span class="params">(self, data)</span>:</span></div><div class="line">        log.msg(<span class="string">'Cmd received from %s : %s'</span> % (self.client_ip, data))</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RPCFactory</span><span class="params">(ServerFactory)</span>:</span></div><div class="line">    <span class="comment"># 使用 CmdProtocol 与客户端通信</span></div><div class="line">    protocol = CmdProtocol</div><div class="line">    </div><div class="line">    <span class="comment"># 设置最大连接数</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, clients_max=<span class="number">10</span>)</span>:</span></div><div class="line">        self.clients_max = clients_max</div><div class="line">        self.clients = []</div><div class="line"></div><div class="line"><span class="comment"># 启动服务器</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    log.startLogging(sys.stdout)</div><div class="line">    reactor.listenTCP(PORT, RPCFactory())</div><div class="line">    reactor.run()</div></pre></td></tr></table></figure>
<h3 id="Step-3-增加-rpc-实例"><a href="#Step-3-增加-rpc-实例" class="headerlink" title="Step 3 增加 rpc 实例"></a>Step 3 增加 rpc 实例</h3><p>既然是 rpc 服务器，辣么接下来就要实现一个简单的远程命令调用，既然之前写了日志模块，那就写一个对应的远程日志查看调用吧！</p>
<p>对了，写到这里，已经是 02：53 了，我不知道为什么开始胡思乱想起来。</p>
<p>我想大概是因为越是无端的，越是会心念着…</p>
<p><img src="https://img1.doubanio.com/view/status/median/public/e818b8c2b37c179.jpg" alt="飘渺心事"></p>
<p>嗷，跑题了…</p>
<p>远程调用呢， Twisted 提供了一个敲好用的子进程父类 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">这个类提供了2个接口:</div><div class="line"></div><div class="line">- outReceived 用来接收和外发数据</div><div class="line">- processEnded 进程结束回调</div><div class="line"></div><div class="line">于是，我在 server.py 中加入以下代码:</div><div class="line"></div><div class="line">``` python</div><div class="line"># 打印日志</div><div class="line">class TailProtocol(ProcessProtocol):</div><div class="line">    def __init__(self, write_callback):</div><div class="line">        self.write = write_callback</div><div class="line">    </div><div class="line">    def outReceived(self, data):</div><div class="line">        self.write(&quot;Begin logger\n&quot;)</div><div class="line">        data = [line for line in data.split(&apos;\n&apos;) if not line.startswith(&apos;==&apos;)]</div><div class="line">        for d in data:</div><div class="line">            self.write(d + &apos;\n&apos;)</div><div class="line">        self.write(&quot;End logger\n&quot;)</div><div class="line"></div><div class="line">     def processEnded(self, reason):</div><div class="line">        if reason.value.exitCode != 0:</div><div class="line">            log.msg(reason)</div></pre></td></tr></table></figure></p>
<p>循环读取日志文件中每一行并输出信息。</p>
<p>接着在 CmdProtocol 类中加入以下函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 根据 cmd 执行相应操作</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">processCmd</span><span class="params">(self, line)</span>:</span></div><div class="line">      <span class="keyword">if</span> line.startwith(<span class="string">'getlog'</span>):</div><div class="line">          tailProtocol = TailProtocol(self.transport.write)</div><div class="line">          <span class="comment"># 打印rpcserver.log日志</span></div><div class="line">          reactor.spawnProcess(tailProtocol, <span class="string">'/usr/bin/tail'</span>, args=[<span class="string">'/usr/bin/tail'</span>, <span class="string">'-10'</span>, <span class="string">'/var/log/rpcserver.log'</span>])</div></pre></td></tr></table></figure>
<p>通过获取远程发送来的命令 「getlog」 触发了以下事件 tailProtocol ，并调用 TailProtocol 类中的回调函数 outReceived 来循环读取日志文件中每一行并输出日志信息，返回给客户端。</p>
<p>同理，其余 RPC 远程调用实例也可类似的编写。</p>
<p>注意，这里使用了 Twisted 自带的 <figure class="highlight plain"><figcaption><span>来处理事件回调，并新建一个线程来执行函数，这就是单个连接中并发的实现。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### Step 4 加入 gevent 协程部分</div><div class="line"></div><div class="line">首先我考虑的是使用一个队列来储存每次接收到事件触发的钩子后，把钩子接收的参数存入队列中，再用 gevent 的协程来进行任务的分发。</div><div class="line"></div><div class="line">直接上代码：</div><div class="line"></div><div class="line">``` python</div><div class="line"># server.py</div><div class="line">import geventfrom gevent.queue</div><div class="line">import Queue</div><div class="line"></div><div class="line"># 任务队列</div><div class="line">tasks = Queue() </div><div class="line"></div><div class="line">class CmdProtocol(LineReceiver):</div><div class="line">      def worker(self, target):</div><div class="line">          while not tasks.empty():</div><div class="line">            task = tasks.get()</div><div class="line">            log.msg(&apos;User %s got task %s&apos; % (target, task))</div><div class="line">            self.processCmd(task)</div><div class="line">            gevent.sleep(0)</div><div class="line"></div><div class="line">      def dispatch(self, data):</div><div class="line">          tasks.put_nowait(data)</div><div class="line">      </div><div class="line">      def dataReceived(self, data):</div><div class="line">          log.msg(&apos;Cmd received from %s : %s&apos; % (self.client_ip, data))</div><div class="line">          gevent.spawn(self.dispatch, data).join()</div><div class="line">          gevent.spawn(self.worker, self.client_ip)</div></pre></td></tr></table></figure></p>
<p>首先， gevent 的队列 Queue 有两个主要的方法 <code>get()</code> 和 <code>put()</code> 来对队列中的元素进行读和写。<code>put_nowait()</code> 相当于 <code>put()</code> 的无阻塞模式。</p>
<p>在 <code>dispatch()</code> 中，我把每个收到的 data 的 trigger 放入任务队列中，使其进入等待分发的状态。</p>
<p>接着，协程会执行下一步 <code>worker()</code>从任务队列中取出相应的 trigger ，传入 <code>processCmd</code> 中触发回调，执行相应的函数。</p>
<p>执行完后，协程会回到上一步 <code>dispatch()</code> 接着再到 <code>worker()</code>  这样交替轮循，直到任务列表里的任务全部执行完为止，这个过程中，各个任务执行是独立的，不会造成阻塞，吊！</p>
<h2 id="欧勒！"><a href="#欧勒！" class="headerlink" title="欧勒！"></a>欧勒！</h2><p>就酱，我们撸出了一个高性能的、协程的、异步的 RPC 服务器！</p>
<p><img src="http://7xse6j.com1.z0.glb.clouddn.com/twisted.png" alt="rpcserver"></p>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                


    <!-- 使用 DISQUS -->
	<div id="disqus-comment">
		<div id="disqus_thread"></div>
<script>
	var disqus_config = function () {
		this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
		this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};

	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//thehackercat.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
	</div>
	<style>
		#disqus-comment{
			background-color:#eee;
			padding:2pc;
		}
	</style>

            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2016/07/16/如果大脑有一套日志系统就好了/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/04/06/2016-04-06-DRF-tutorial-5-relations/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="LexusLee's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        lexuscyborg103@email.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="mailto:lexuscyborg103@gmail.com" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             Home
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             Archives
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2019/08/">August 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/07/">July 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/09/">September 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/08/">August 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">February 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">December 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">September 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">August 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">July 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">April 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">March 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">July 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">April 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">March 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">February 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">December 2015<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">November 2015<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">May 2015<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">April 2015<span class="sidebar_archives-count">1</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
		<li>
			<a href="http://thehackercat.deercv.com/" title="About me">
				About me
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
             Article Number
             <span class="sidebar-badge">33</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		Theme - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				
					<!-- Footer Top Button -->
					<div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>
				
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    

    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    <a href="https://www.instagram.com/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-instagram.png);">
        <span class="visuallyhidden">Instagram</span>
    </button></a>
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://github.com/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    

    <!-- Douban -->
    
    <a href="https://www.douban.com/people/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-douban.png);">
        <span class="visuallyhidden">Douban</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;LexusLee's Blog</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/highlight.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>






    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





    <!-- 使用 DISQUS js 代码 -->
	<script id="dsq-count-scr" src="//thehackercat.disqus.com/count.js" async></script>


<!-- Swiftye -->


<!-- Local Search-->

	<script>
	var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ data_title;
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 6;
                            var end = first_occur + 6;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
                            str += "<p class=\"search-result\">" + match_content +"...</p>" +"</a>";
                        }
                    }
                })
                $resultContent.innerHTML = str;
            })
        }
    })
}
</script>

	<script>
        var inputArea = document.querySelector("#search");
        var getSearchFile = function(){
            var path = "search.xml";
            searchFunc(path, 'search', 'local-search-result');
        }

        inputArea.onfocus = function(){ getSearchFile() }
	</script>


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $(".post-toc-wrap").parent(".mdl-menu__container").css("position", "fixed");
    });
</script>
            </main>
        </div>
		
    </body>
		
	
</html>
