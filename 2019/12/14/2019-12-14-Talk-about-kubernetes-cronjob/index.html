<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        Talk about Kubernetes cronJob controller | LexusLee&#39;s Blog
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="LexusLee">
    <meta name="description" content="Be the change you want to see in the world.">
    <meta name="keywords" content="Lexus">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="LexusLee&#39;s Blog">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://lexuslee.me">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Talk about Kubernetes cronJob controller | LexusLee&#39;s Blog">
    <meta property="og:description" content="Be the change you want to see in the world.">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #00838F
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important
    }
    
	/* Sidebar User Drop Down Menu Text Color */
	#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #0097A7 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #0097A7 !important
    }
    
    .toTop{
        background: #757575 !important
    }
		
	.material-layout .material-post>.material-nav,
	.material-layout .material-index>.material-nav,
	.material-nav a{
		color: #757575;
	}
		
	#scheme-Paradox .MD-burger-layer {
		background-color: #757575;
	}

	#scheme-Paradox #post-toc-trigger-btn{
		color: #757575;
	}
	
	.post-toc a:hover{
		color: #00838F;
		text-decoration: underline;
	}
</style>


<!-- Theme Background Related-->

	<style>
		body{
            background-image: url(https://api.i-meto.com/bing?null);
        }
	</style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>

	<script src="/js/jquery.min.js"></script>
	
	<link rel="stylesheet" href="/css/highlight/solarized-white.css">
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                
	<!-- Back Button -->
<!--
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			
-->
	<!-- Left aligned menu below button -->
	<button id="post-toc-trigger-btn"
			class="mdl-button mdl-js-button mdl-button--icon">
	  <i class="material-icons">format_list_numbered</i>
	</button>

	<ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect"
		for="post-toc-trigger-btn">
			
			<ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#背景"><span class="post-toc-number">1.</span> <span class="post-toc-text">背景</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#存在的问题"><span class="post-toc-number">2.</span> <span class="post-toc-text">存在的问题</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#代码解读"><span class="post-toc-number">3.</span> <span class="post-toc-text">代码解读</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#调优"><span class="post-toc-number">4.</span> <span class="post-toc-text">调优</span></a></li></ol>
		
<!--			<li class="mdl-menu__item">Some Action</li>-->
	</ul>


<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
		
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		<!-- Custom Thumbnail -->
		<div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(https://blog.johnwu.cc/images/featured/kubernetes.png)">
	
        <p class="article-headline-p">
            Talk about Kubernetes cronJob controller
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>LexusLee</strong>
        <span>Dec 14, 2019</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/kubernetes/">kubernetes</a>
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Talk about Kubernetes cronJob controller&url=http://lexuslee.me//2019/12/14/2019-12-14-Talk-about-kubernetes-cronjob/index.html&via=LexusLee" target="_blank">
        <li class="mdl-menu__item">
            Share to Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://lexuslee.me//2019/12/14/2019-12-14-Talk-about-kubernetes-cronjob/index.html" target="_blank">
        <li class="mdl-menu__item">
            Share to Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Talk about Kubernetes cronJob controller&url=http://lexuslee.me//2019/12/14/2019-12-14-Talk-about-kubernetes-cronjob/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            Share to Weibo
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>之前一段时间正好接触到 kubernetes cronjob, 在接入时遇上了在一定量级下 cronjob schedule delay 的问题, 故开始读了下代码, 发现了一些问题并试着调优了下</p>
<h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><p>按生产环境实际测试来看约 250-375  个 <code>*/1 * * * *</code>  每分钟 interval 的 cronjob 就会产生 delay, cronjob 和 controller manager 没有异常 event  但新产生的 job 出现了延迟, 由于我们设置了 <code>startingDeadlineSeconds</code> 故累加起来的 delay 最终导致了 cron 任务严重滞后</p>
<h3 id="代码解读"><a href="#代码解读" class="headerlink" title="代码解读"></a>代码解读</h3><p>出于分析上述问题的目的, 读了下 cronjob controller 的代码, 代码量不多, 可能由于<a href="https://github.com/kubernetes/enhancements/pull/978" target="_blank" rel="external">没上 GA</a> 的原因, 整个 controllor 代码的设计也比较过程式, 不会像其他组件用到一些比如 Informer, refractor, watch 之类的组件读起来相对晦涩</p>
<p>下面开始解读下 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.17/pkg/controller/cronjob/cronjob_controller.go" target="_blank" rel="external">release1.17</a> 分支的 k8s cronjob controller 代码</p>
<ul>
<li>Controller struct</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span> &#123;</div><div class="line">	kubeClient clientset.Interface</div><div class="line">	jobControl jobControlInterface</div><div class="line">	sjControl  sjControlInterface</div><div class="line">	podControl podControlInterface</div><div class="line">	recorder   record.EventRecorder</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>cronjob controller instance, 即下文中常见的 jm(jobManager) </p>
<ul>
<li>入口函数 Run:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Run starts the main goroutine responsible for watching and syncing jobs.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(jm *Controller)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> utilruntime.HandleCrash()</div><div class="line">	klog.Infof(<span class="string">"Starting CronJob Manager"</span>)</div><div class="line">	<span class="comment">// Check things every 10 second.</span></div><div class="line">	<span class="keyword">go</span> wait.Until(jm.syncAll, <span class="number">10</span>*time.Second, stopCh)</div><div class="line">	&lt;-stopCh</div><div class="line">	klog.Infof(<span class="string">"Shutting down CronJob Manager"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>cronjob controller 是个单线程单执行流的调度器, 由固定每 10s 的 interval 做一次 syncAll 调用</p>
<ul>
<li>主 loop 函数 syncAll</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// syncAll lists all the CronJobs and Jobs and reconciles them.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(jm *Controller)</span> <span class="title">syncAll</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// List children (Jobs) before parents (CronJob).</span></div><div class="line">	<span class="comment">// This guarantees that if we see any Job that got orphaned by the GC orphan finalizer,</span></div><div class="line">	<span class="comment">// we must also see that the parent CronJob has non-nil DeletionTimestamp (see #42639).</span></div><div class="line">	<span class="comment">// Note that this only works because we are NOT using any caches here.</span></div><div class="line">	jobListFunc := <span class="function"><span class="keyword">func</span><span class="params">(opts metav1.ListOptions)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> jm.kubeClient.BatchV1().Jobs(metav1.NamespaceAll).List(opts)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	js := <span class="built_in">make</span>([]batchv1.Job, <span class="number">0</span>)</div><div class="line">	err := pager.New(pager.SimplePageFunc(jobListFunc)).EachListItem(context.Background(), metav1.ListOptions&#123;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(object runtime.Object)</span> <span class="title">error</span></span> &#123;</div><div class="line">		jobTmp, ok := object.(*batchv1.Job)</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected type *batchv1.Job, got type %T"</span>, jobTmp)</div><div class="line">		&#125;</div><div class="line">		js = <span class="built_in">append</span>(js, *jobTmp)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		utilruntime.HandleError(fmt.Errorf(<span class="string">"Failed to extract job list: %v"</span>, err))</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	klog.V(<span class="number">4</span>).Infof(<span class="string">"Found %d jobs"</span>, <span class="built_in">len</span>(js))</div><div class="line">	cronJobListFunc := <span class="function"><span class="keyword">func</span><span class="params">(opts metav1.ListOptions)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> jm.kubeClient.BatchV1beta1().CronJobs(metav1.NamespaceAll).List(opts)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	jobsBySj := groupJobsByParent(js)</div><div class="line">	klog.V(<span class="number">4</span>).Infof(<span class="string">"Found %d groups"</span>, <span class="built_in">len</span>(jobsBySj))</div><div class="line">	err = pager.New(pager.SimplePageFunc(cronJobListFunc)).EachListItem(context.Background(), metav1.ListOptions&#123;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(object runtime.Object)</span> <span class="title">error</span></span> &#123;</div><div class="line">		sj, ok := object.(*batchv1beta1.CronJob)</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"expected type *batchv1beta1.CronJob, got type %T"</span>, sj)</div><div class="line">		&#125;</div><div class="line">		syncOne(sj, jobsBySj[sj.UID], time.Now(), jm.jobControl, jm.sjControl, jm.recorder)</div><div class="line">		cleanupFinishedJobs(sj, jobsBySj[sj.UID], jm.jobControl, jm.sjControl, jm.recorder)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		utilruntime.HandleError(fmt.Errorf(<span class="string">"Failed to extract cronJobs list: %v"</span>, err))</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先 <code>pager.New(pager.SimplePageFunc(jobListFunc))</code>通过 Pager 调用了 <code>jobListFunc</code> 回调函数, 用于 list 出所有 namespace 下的 k8s job 对象, 并将这些 jobs 加入 slice 中, 这个 slices <code>js := make([]batchv1.Job, 0)</code> 用于在之后对 sync 单个 cronJob 时作为是否已经 trigger job 的判断</p>
<p>同理 <code>pager.New(pager.SimplePageFunc(cronJobListFunc)).EachListItem</code> list 所有 cronjob 对象并对每个对象调用 <code>syncOne</code> 做实际 cronjob 调度, 在调度完后调用 <code>cleanupFinishedJobs</code> 完成清理工作</p>
<ul>
<li><ul>
<li>对于成功执行的 job 根据 <code>HistoryLimit</code> 进行 apiserver 中的资源清理</li>
<li>对于执行失败的 job 按 limitBackoff 的限制进行重试</li>
<li>若处于非上述两种状态的 job 则忽略</li>
</ul>
</li>
<li><p>主调度函数 syncOne</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncOne</span><span class="params">(sj *batchv1beta1.CronJob, js []batchv1.Job, now time.Time, jc jobControlInterface, sjc sjControlInterface, recorder record.EventRecorder)</span></span> &#123;</div><div class="line">	nameForLog := fmt.Sprintf(<span class="string">"%s/%s"</span>, sj.Namespace, sj.Name)</div><div class="line"></div><div class="line">  <span class="comment">// 首先在之前的 batchv1.Job slice 中顺序查找是否有当前 cronJob 的子 job 并且看看是否有不在 jobActive 列表中的孤儿，以及已经执行完成但是还在 Active 列表中的 job，根据 job 状态记录 event (UnexpectedJob, SawCompletedJob)，删掉不对应的状态</span></div><div class="line">	childrenJobs := <span class="built_in">make</span>(<span class="keyword">map</span>[types.UID]<span class="keyword">bool</span>)</div><div class="line">	<span class="keyword">for</span> _, j := <span class="keyword">range</span> js &#123;</div><div class="line">		childrenJobs[j.ObjectMeta.UID] = <span class="literal">true</span></div><div class="line">		found := inActiveList(*sj, j.ObjectMeta.UID)</div><div class="line">		<span class="keyword">if</span> !found &amp;&amp; !IsJobFinished(&amp;j) &#123;</div><div class="line">			recorder.Eventf(sj, v1.EventTypeWarning, <span class="string">"UnexpectedJob"</span>, <span class="string">"Saw a job that the controller did not create or forgot: %s"</span>, j.Name)</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> found &amp;&amp; IsJobFinished(&amp;j) &#123;</div><div class="line">			_, status := getFinishedStatus(&amp;j)</div><div class="line">			deleteFromActiveList(sj, j.ObjectMeta.UID)</div><div class="line">			recorder.Eventf(sj, v1.EventTypeNormal, <span class="string">"SawCompletedJob"</span>, <span class="string">"Saw completed job: %s, status: %v"</span>, j.Name, status)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 接着判断 Active 列表中是否有不在当前 cronjob 子 job 里的 job, 如果有则记录 MissingJob event 并从 Active 列表中移除</span></div><div class="line">	<span class="keyword">for</span> _, j := <span class="keyword">range</span> sj.Status.Active &#123;</div><div class="line">		<span class="keyword">if</span> found := childrenJobs[j.UID]; !found &#123;</div><div class="line">			recorder.Eventf(sj, v1.EventTypeNormal, <span class="string">"MissingJob"</span>, <span class="string">"Active job went missing: %v"</span>, j.Name)</div><div class="line">			deleteFromActiveList(sj, j.UID)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 更新 cronjob 的状态</span></div><div class="line">	updatedSJ, err := sjc.UpdateStatus(sj)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		klog.Errorf(<span class="string">"Unable to update status for %s (rv = %s): %v"</span>, nameForLog, sj.ResourceVersion, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	*sj = *updatedSJ</div><div class="line"></div><div class="line">  <span class="comment">// 判断 cronjob 是否被删除, 若被删除则停止调度该 cronjob</span></div><div class="line">	<span class="keyword">if</span> sj.DeletionTimestamp != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// The CronJob is being deleted.</span></div><div class="line">		<span class="comment">// Don't do anything other than updating status.</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">  </div><div class="line">  <span class="comment">// 判断 cronjob 是否被暂停, 若被暂停则停止调度该 cronjob</span></div><div class="line">	<span class="keyword">if</span> sj.Spec.Suspend != <span class="literal">nil</span> &amp;&amp; *sj.Spec.Suspend &#123;</div><div class="line">		klog.V(<span class="number">4</span>).Infof(<span class="string">"Not starting job for %s because it is suspended"</span>, nameForLog)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// getRecentUnmetScheduleTimes 是按 crontab 算法计算出的 job 执行时间表</span></div><div class="line">	times, err := getRecentUnmetScheduleTimes(*sj, now)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		recorder.Eventf(sj, v1.EventTypeWarning, <span class="string">"FailedNeedsStart"</span>, <span class="string">"Cannot determine if job needs to be started: %v"</span>, err)</div><div class="line">		klog.Errorf(<span class="string">"Cannot determine if %s needs to be started: %v"</span>, nameForLog, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 若没有取到该 cronjob 的 table 时间表, 则认为该 job nextSchedule time 可能不合理, 停止调度该 cronjob</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(times) == <span class="number">0</span> &#123;</div><div class="line">		klog.V(<span class="number">4</span>).Infof(<span class="string">"No unmet start times for %s"</span>, nameForLog)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 若取到时间表, 则计算出最近一次需要执行的时间, 若最近一次执行时间超过了 currentTime + StartingDeadlineSeconds 则标记为 tooLate 停止调度并记录 event</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(times) &gt; <span class="number">1</span> &#123;</div><div class="line">		klog.V(<span class="number">4</span>).Infof(<span class="string">"Multiple unmet start times for %s so only starting last one"</span>, nameForLog)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	scheduledTime := times[<span class="built_in">len</span>(times)<span class="number">-1</span>]</div><div class="line">	tooLate := <span class="literal">false</span></div><div class="line">	<span class="keyword">if</span> sj.Spec.StartingDeadlineSeconds != <span class="literal">nil</span> &#123;</div><div class="line">		tooLate = scheduledTime.Add(time.Second * time.Duration(*sj.Spec.StartingDeadlineSeconds)).Before(now)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> tooLate &#123;</div><div class="line">		klog.V(<span class="number">4</span>).Infof(<span class="string">"Missed starting window for %s"</span>, nameForLog)</div><div class="line">		recorder.Eventf(sj, v1.EventTypeWarning, <span class="string">"MissSchedule"</span>, <span class="string">"Missed scheduled time to start a job: %s"</span>, scheduledTime.Format(time.RFC1123Z))</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 若当前 cronjob 设置了并发策略则按照对应的并发策略进行并行 job 调度</span></div><div class="line">	<span class="keyword">if</span> sj.Spec.ConcurrencyPolicy == batchv1beta1.ForbidConcurrent &amp;&amp; <span class="built_in">len</span>(sj.Status.Active) &gt; <span class="number">0</span> &#123;</div><div class="line">		klog.V(<span class="number">4</span>).Infof(<span class="string">"Not starting job for %s because of prior execution still running and concurrency policy is Forbid"</span>, nameForLog)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> sj.Spec.ConcurrencyPolicy == batchv1beta1.ReplaceConcurrent &#123;</div><div class="line">		<span class="keyword">for</span> _, j := <span class="keyword">range</span> sj.Status.Active &#123;</div><div class="line">			klog.V(<span class="number">4</span>).Infof(<span class="string">"Deleting job %s of %s that was still running at next scheduled start time"</span>, j.Name, nameForLog)</div><div class="line"></div><div class="line">			job, err := jc.GetJob(j.Namespace, j.Name)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				recorder.Eventf(sj, v1.EventTypeWarning, <span class="string">"FailedGet"</span>, <span class="string">"Get job: %v"</span>, err)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> !deleteJob(sj, job, jc, recorder) &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 根据CronJob Spec中JobTemplate的配置获取Job对象，其中Job对象的名字会加上scheduledTime计算出的Hash，目前是unix timestamp</span></div><div class="line">	jobReq, err := getJobFromTemplate(sj, scheduledTime)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		klog.Errorf(<span class="string">"Unable to make Job from template in %s: %v"</span>, nameForLog, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 调用 createJob 接口根据上面拿到的 jobTemplate 创建一个新 job</span></div><div class="line">	jobResp, err := jc.CreateJob(sj.Namespace, jobReq)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// If the namespace is being torn down, we can safely ignore</span></div><div class="line">		<span class="comment">// this error since all subsequent creations will fail.</span></div><div class="line">		<span class="keyword">if</span> !errors.HasStatusCause(err, v1.NamespaceTerminatingCause) &#123;</div><div class="line">			recorder.Eventf(sj, v1.EventTypeWarning, <span class="string">"FailedCreate"</span>, <span class="string">"Error creating job: %v"</span>, err)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	klog.V(<span class="number">4</span>).Infof(<span class="string">"Created Job %s for %s"</span>, jobResp.Name, nameForLog)</div><div class="line">	recorder.Eventf(sj, v1.EventTypeNormal, <span class="string">"SuccessfulCreate"</span>, <span class="string">"Created job %v"</span>, jobResp.Name)</div><div class="line"></div><div class="line">	<span class="comment">// ------------------------------------------------------------------ //</span></div><div class="line"></div><div class="line">	<span class="comment">// If this process restarts at this point (after posting a job, but</span></div><div class="line">	<span class="comment">// before updating the status), then we might try to start the job on</span></div><div class="line">	<span class="comment">// the next time.  Actually, if we re-list the SJs and Jobs on the next</span></div><div class="line">	<span class="comment">// iteration of syncAll, we might not see our own status update, and</span></div><div class="line">	<span class="comment">// then post one again.  So, we need to use the job name as a lock to</span></div><div class="line">	<span class="comment">// prevent us from making the job twice (name the job with hash of its</span></div><div class="line">	<span class="comment">// scheduled time).</span></div><div class="line"></div><div class="line">	<span class="comment">// 将刚创建的Job加到CronJob的Active列表中，设置LastScheduleTime，更新CronJob</span></div><div class="line">	ref, err := getRef(jobResp)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		klog.V(<span class="number">2</span>).Infof(<span class="string">"Unable to make object reference for job for %s"</span>, nameForLog)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		sj.Status.Active = <span class="built_in">append</span>(sj.Status.Active, *ref)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// lastSchedulerTime 常用于监控判断 job schedule 是否符合预期</span></div><div class="line">	sj.Status.LastScheduleTime = &amp;metav1.Time&#123;Time: scheduledTime&#125;</div><div class="line">	<span class="keyword">if</span> _, err := sjc.UpdateStatus(sj); err != <span class="literal">nil</span> &#123;</div><div class="line">		klog.Infof(<span class="string">"Unable to update status for %s (rv = %s): %v"</span>, nameForLog, sj.ResourceVersion, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>获取 cron table 的 <code>getRecentUnmetScheduleTimes</code> 函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getRecentUnmetScheduleTimes</span><span class="params">(sj batchv1beta1.CronJob, now time.Time)</span> <span class="params">([]time.Time, error)</span></span> &#123;</div><div class="line">	starts := []time.Time&#123;&#125;</div><div class="line">	<span class="comment">// 使用robfig/cron对Schedule进行解析</span></div><div class="line">	sched, err := cron.ParseStandard(sj.Spec.Schedule)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> starts, fmt.Errorf(<span class="string">"Unparseable schedule: %s : %s"</span>, sj.Spec.Schedule, err)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 判断初始时间，如果CronJob之前被执行过，则以上次执行实现为准，如果没有执行过，则以CronJob创建时间为准</span></div><div class="line">	<span class="keyword">var</span> earliestTime time.Time</div><div class="line">	<span class="keyword">if</span> sj.Status.LastScheduleTime != <span class="literal">nil</span> &#123;</div><div class="line">		earliestTime = sj.Status.LastScheduleTime.Time</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// If none found, then this is either a recently created scheduledJob,</span></div><div class="line">		<span class="comment">// or the active/completed info was somehow lost (contract for status</span></div><div class="line">		<span class="comment">// in kubernetes says it may need to be recreated), or that we have</span></div><div class="line">		<span class="comment">// started a job, but have not noticed it yet (distributed systems can</span></div><div class="line">		<span class="comment">// have arbitrary delays).  In any case, use the creation time of the</span></div><div class="line">		<span class="comment">// CronJob as last known start time.</span></div><div class="line">		earliestTime = sj.ObjectMeta.CreationTimestamp.Time</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 如果设置了StartingDeadlineSeconds，并且当前时间减去该值比初始时间还晚，那就以新的时间为准</span></div><div class="line">	<span class="keyword">if</span> sj.Spec.StartingDeadlineSeconds != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Controller is not going to schedule anything below this point</span></div><div class="line">		schedulingDeadline := now.Add(-time.Second * time.Duration(*sj.Spec.StartingDeadlineSeconds))</div><div class="line">		<span class="keyword">if</span> schedulingDeadline.After(earliestTime) &#123;</div><div class="line">			earliestTime = schedulingDeadline</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 如果初始时间比现在还晚，直接跳过了</span></div><div class="line">	<span class="keyword">if</span> earliestTime.After(now) &#123;</div><div class="line">		<span class="keyword">return</span> []time.Time&#123;&#125;, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 计算从初始时间到现在所有需要执行的任务的时间</span></div><div class="line">	<span class="comment">// 主要有可能一个Cron会错过很多次执行，所以需要计算所有的，但是如果超过太多，也就没有意义了。只关注前100个</span></div><div class="line">	<span class="keyword">for</span> t := sched.Next(earliestTime); !t.After(now); t = sched.Next(t) &#123;</div><div class="line">		starts = <span class="built_in">append</span>(starts, t)</div><div class="line">		<span class="comment">// An object might miss several starts. For example, if</span></div><div class="line">		<span class="comment">// controller gets wedged on friday at 5:01pm when everyone has</span></div><div class="line">		<span class="comment">// gone home, and someone comes in on tuesday AM and discovers</span></div><div class="line">		<span class="comment">// the problem and restarts the controller, then all the hourly</span></div><div class="line">		<span class="comment">// jobs, more than 80 of them for one hourly scheduledJob, should</span></div><div class="line">		<span class="comment">// all start running with no further intervention (if the scheduledJob</span></div><div class="line">		<span class="comment">// allows concurrency and late starts).</span></div><div class="line">		<span class="comment">//</span></div><div class="line">		<span class="comment">// However, if there is a bug somewhere, or incorrect clock</span></div><div class="line">		<span class="comment">// on controller's server or apiservers (for setting creationTimestamp)</span></div><div class="line">		<span class="comment">// then there could be so many missed start times (it could be off</span></div><div class="line">		<span class="comment">// by decades or more), that it would eat up all the CPU and memory</span></div><div class="line">		<span class="comment">// of this controller. In that case, we want to not try to list</span></div><div class="line">		<span class="comment">// all the missed start times.</span></div><div class="line">		<span class="comment">//</span></div><div class="line">		<span class="comment">// I've somewhat arbitrarily picked 100, as more than 80,</span></div><div class="line">		<span class="comment">// but less than "lots".</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(starts) &gt; <span class="number">100</span> &#123;</div><div class="line">			<span class="comment">// We can't get the most recent times so just return an empty slice</span></div><div class="line">			<span class="keyword">return</span> []time.Time&#123;&#125;, fmt.Errorf(<span class="string">"Too many missed start time (&gt; 100). Set or decrease .spec.startingDeadlineSeconds or check clock skew."</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> starts, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基本上主要的业务逻辑都在这里了，整体上看还是十分简单粗暴的，是个单执行流 one by one 地不停轮询、计算需要执行的任务、任务执行时间表、同步任务状态的处理过程。</p>
<p>其中从上面观察到两点:</p>
<ul>
<li>在 syncAll 函数中用到 pageList 这是个非常冗余的操作, 应该改为 watch</li>
<li>对于 cronjob 状态的变更可以不通过在每次 loop 时主动查询并更新, 而是通过 informer 注册 event 回调的方式, 在有变更时同步状态</li>
</ul>
<h3 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h3><p>说回到之前遇到的 delay 问题, 看社区中也有遇到类似的情况, 大概率是 pageList 的原因, 故改成了 page.Watch 并放到 WorkQueue 中重新 build 了一份, 果然解决了！</p>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                


    <!-- 使用 DISQUS -->
	<div id="disqus-comment">
		<div id="disqus_thread"></div>
<script>
	var disqus_config = function () {
		this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
		this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};

	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//thehackercat.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
	</div>
	<style>
		#disqus-comment{
			background-color:#eee;
			padding:2pc;
		}
	</style>

            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2019/08/05/2019-08-05-You-are-my-sunshine/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="LexusLee's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        lexuscyborg103@email.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="mailto:lexuscyborg103@gmail.com" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             Home
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             Archives
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2019/12/">December 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/08/">August 2019<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/07/">July 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/09/">September 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/08/">August 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">February 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">December 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">September 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">August 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">July 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">April 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">March 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">July 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">April 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">March 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">February 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">December 2015<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">November 2015<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">May 2015<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">April 2015<span class="sidebar_archives-count">1</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
		<li>
			<a href="http://thehackercat.deercv.com/" title="About me">
				About me
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
             Article Number
             <span class="sidebar-badge">36</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		Theme - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				
					<!-- Footer Top Button -->
					<div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>
				
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    

    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    <a href="https://www.instagram.com/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-instagram.png);">
        <span class="visuallyhidden">Instagram</span>
    </button></a>
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://github.com/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    

    <!-- Douban -->
    
    <a href="https://www.douban.com/people/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-douban.png);">
        <span class="visuallyhidden">Douban</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;LexusLee's Blog</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/highlight.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>






    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





    <!-- 使用 DISQUS js 代码 -->
	<script id="dsq-count-scr" src="//thehackercat.disqus.com/count.js" async></script>


<!-- Swiftye -->


<!-- Local Search-->

	<script>
	var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ data_title;
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 6;
                            var end = first_occur + 6;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
                            str += "<p class=\"search-result\">" + match_content +"...</p>" +"</a>";
                        }
                    }
                })
                $resultContent.innerHTML = str;
            })
        }
    })
}
</script>

	<script>
        var inputArea = document.querySelector("#search");
        var getSearchFile = function(){
            var path = "search.xml";
            searchFunc(path, 'search', 'local-search-result');
        }

        inputArea.onfocus = function(){ getSearchFile() }
	</script>


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $(".post-toc-wrap").parent(".mdl-menu__container").css("position", "fixed");
    });
</script>
            </main>
        </div>
		
    </body>
		
	
</html>
